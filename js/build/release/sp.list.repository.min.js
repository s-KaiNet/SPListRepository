Type.registerNamespace("SPListRepo"),SPListRepo.Helpers=function(){"use strict";return{ensureTrailingSlash:function(a){return a.endsWith("/")?a:a+"/"},ensureLeadingSlash:function(a){return a.startsWith("/")?a:"/"+a}}}(jQuery),function(){"use strict";window.SPListRepo.isDebug=0}(),Type.registerNamespace("SPListRepo.Fields"),Type.registerNamespace("SPListRepo.ErrorCodes"),function(a){"use strict";a.ErrorCodes.FolderAlreadyExists=-2130245363,a.ErrorCodes.IllegalName=-2130575245,a.Fields.Modified="Modified",a.Fields.Created="Created",a.Fields.ModifiedBy="Editor",a.Fields.CreatedBy="Author",a.Fields.ID="ID",a.Fields.FSObjType="FSObjType",a.Fields.Title="Title",a.Fields.FileLeafRef="FileLeafRef",a.Fields.FileDirRef="FileDirRef",a.Fields.ContentTypeId="ContentTypeId"}(SPListRepo),SPListRepo.RequestError=function(){"use strict";function a(a){a instanceof SP.ClientRequestFailedEventArgs?(this.stackTrace=a.get_stackTrace(),this.message=a.get_message(),this.correlation=a.get_errorTraceCorrelationId(),this.errorCode=a.get_errorCode(),this.details=a.get_errorDetails(),this.errorType=a.get_errorTypeName()):"string"==typeof a&&(this.message=a)}return a}(),SPListRepo.RequestError.registerClass("SPListRepo.RequestError"),SPListRepo.ListService=function(a){"use strict";var b={};return{getListByUrl:function(c){if(b[c])return b[c];var d=a.Deferred();b[c]=d;var e=SPListRepo.Helpers.ensureTrailingSlash(_spPageContextInfo.webAbsoluteUrl),f=SPListRepo.Helpers.ensureTrailingSlash(_spPageContextInfo.webServerRelativeUrl),g=String.format("{0}_api/web/lists/?$expand=RootFolder&$filter=RootFolder/ServerRelativeUrl eq '{1}{2}'&$select=ID",e,f,c);return a.ajax({url:g,type:"GET",contentType:"application/json;odata=verbose",headers:{Accept:"application/json;odata=verbose"},success:function(a){var e=SP.ClientContext.get_current(),f=e.get_web().get_lists().getById(a.d.results[0].Id);e.load(f),e.executeQueryAsync(function(){b[c]=f,d.resolve(f)},function(a,b){d.reject(new SPListRepo.RequestError(b))})},error:function(a,b){d.reject(new SPListRepo.RequestError(b))}}),d.promise()}}}(jQuery),SPListRepo.ViewScope=function(){},SPListRepo.ViewScope.prototype={FilesOnly:0,FoldersOnly:1,FilesFolders:2,FilesOnlyRecursive:3,FoldersOnlyRecursive:4,FilesFoldersRecursive:5},SPListRepo.ViewScope.registerEnum("SPListRepo.ViewScope",!1),SPListRepo.QuerySettings=function(){"use strict";function a(a,b,c){var d=Function.validateParameters(arguments,[{name:"viewScope",type:SPListRepo.ViewScope,optional:!0},{name:"viewFields",type:Array,elementType:String,optional:!0},{name:"rowLimit",type:Number,optional:!0}],!0);if(d)throw d;this.viewScope=a,this.viewFields=b,this.rowLimit=c}return a}(),SPListRepo.QuerySettings.registerClass("SPListRepo.QuerySettings"),SPListRepo.BaseListItem=function(){"use strict";function a(a){var b=Function.validateParameters(arguments,[{name:"item",type:SP.ListItem}],!0);if(b)throw b;this.item=a,this.id=a.get_id(),this.created=a.get_item(SPListRepo.Fields.Created),this.createdBy=a.get_item(SPListRepo.Fields.CreatedBy),this.modified=a.get_item(SPListRepo.Fields.Modified),this.modifiedBy=a.get_item(SPListRepo.Fields.ModifiedBy),this.title=a.get_item(SPListRepo.Fields.Title),this.fileDirRef=a.get_item(SPListRepo.Fields.FileDirRef),this.fsObjectType=a.get_item(SPListRepo.Fields.FSObjType),this.isFolder="1"===this.fsObjectType}return a}(),SPListRepo.BaseListItem.registerClass("SPListRepo.BaseListItem"),SPListRepo.ListRepository=function(a){"use strict";function b(a,b){var c=Function.validateParameters(arguments,[{name:"listUrl",type:String},{name:"listItemConstructor",type:Function}],!0);if(c)throw c;this._listUrl=a,this._listItemConstructor=b,this._context=SP.ClientContext.get_current(),this._loadListDeffered=SPListRepo.ListService.getListByUrl(this._listUrl),this._loadListDeffered.done(Function.createDelegate(this,function(a){this._list=a})),this.folder=null}return b.prototype={getItems:function(a){var b=Function.validateParameters(arguments,[{name:"querySettings",type:SPListRepo.QuerySettings,optional:!0}],!0);if(b)throw b;return this._getItemsByQuery(null,a)},getItemById:function(a){var b=Function.validateParameters(arguments,[{name:"id",type:Number}],!0);if(b)throw b;var c=this._createDeferred();return this._loadListDeffered.done(Function.createDelegate(this,function(){var b=this._list.getItemById(a);this._context.load(b);var d=this;this._context.executeQueryAsync(function(){var a=new d._listItemConstructor(b);c.resolve(a)},function(a,b){c.reject(new SPListRepo.RequestError(b))})})),c.promise()},getItemsByIds:function(a,b){var c=Function.validateParameters(arguments,[{name:"ids",type:Array,elementType:Number},{name:"querySettings",type:SPListRepo.QuerySettings,optional:!0}]);if(c)throw c;var d=CamlBuilder.Expression().CounterField(SPListRepo.Fields.ID).In(a);return this._getItemsByQuery(d,b)},getItemsInsideFolders:function(a,b){var c=Function.validateParameters(arguments,[{name:"folderNames",type:Array,elementType:String},{name:"querySettings",type:SPListRepo.QuerySettings,optional:!0}]);if(c)throw c;var d=this,e=CamlBuilder.Expression().TextField(SPListRepo.Fields.FileDirRef).In(a.map(function(a){var b=d._getFolderRelativeUrl(a);return b.startsWith("/")&&(b=b.substring(1)),b}));return this._getItemsByQuery(e,b)},getLastAddedItem:function(a){var b=Function.validateParameters(arguments,[{name:"querySettings",type:SPListRepo.QuerySettings,optional:!0}]);if(b)throw b;var c=CamlBuilder.Expression().CounterField(SPListRepo.Fields.ID).NotEqualTo(0).OrderByDesc(SPListRepo.Fields.ID);return a=a||new SPListRepo.QuerySettings(SPListRepo.ViewScope.FilesFolders),a.rowLimit=1,this._getItemByQuery(c,a)},saveItem:function(a){var b=Function.validateParameters(arguments,[{name:"model",type:this._listItemConstructor}],!0);if(b)throw b;return!a.id||a.id<1?this._addItem(a):this._updateItem(a)},deleteItem:function(a){var b=Function.validateParameters(arguments,[{name:"model",type:this._listItemConstructor}],!0);if(b)throw b;var c=this._createDeferred();return this._loadListDeffered.done(Function.createDelegate(this,function(){var b=this._list.getItemById(a.id);this._context.load(b),b.deleteObject(),this._context.executeQueryAsync(function(){c.resolve()},function(a,b){c.reject(new SPListRepo.RequestError(b))})})),c.promise()},createFolder:function(a){var b=Function.validateParameters(arguments,[{name:"folderName",type:String}],!0);if(b)throw b;var c=this._createDeferred();return this._loadListDeffered.done(Function.createDelegate(this,function(){var b=new SP.ListItemCreationInformation;b.set_underlyingObjectType(SP.FileSystemObjectType.folder),b.set_leafName(a);var d=this._list.addItem(b);d.set_item("Title",a),d.update(),this._context.load(d),this._context.executeQueryAsync(function(){c.resolve(d)},function(a,b){c.reject(new SPListRepo.RequestError(b))})})),c.promise()},_createDeferred:function(){return a.Deferred()},_addItem:function(a){var b=Function.validateParameters(arguments,[{name:"model",type:this._listItemConstructor}],!0);if(b)throw b;var c=this._createDeferred();return this._loadListDeffered.done(Function.createDelegate(this,function(){var b=new SP.ListItemCreationInformation;this.folder&&b.set_folderUrl(this._getFolderRelativeUrl());var d=this._list.addItem(b);this._setFieldValues(d,a);var e=this;d.update(),this._context.load(d),this._context.executeQueryAsync(function(){var a=new e._listItemConstructor(d);c.resolve(a)},function(a,b){c.reject(new SPListRepo.RequestError(b))})})),c.promise()},_updateItem:function(a){var b=Function.validateParameters(arguments,[{name:"model",type:this._listItemConstructor}],!0);if(b)throw b;var c=this._createDeferred();return this._loadListDeffered.done(Function.createDelegate(this,function(){var b=this._list.getItemById(a.id);this._context.load(b),this._setFieldValues(b,a);var d=this;b.update(),this._context.executeQueryAsync(function(){var a=new d._listItemConstructor(b);c.resolve(a)},function(a,b){c.reject(new SPListRepo.RequestError(b))})})),c.promise()},_setFieldValues:function(a,b){a.set_item(SPListRepo.Fields.Title,b.title),b.fileLeafRef&&a.set_item(SPListRepo.Fields.FileLeafRef,b.fileLeafRef)},_getFolderRelativeUrl:function(a){var b=a||this.folder,c=SPListRepo.Helpers.ensureTrailingSlash(_spPageContextInfo.webServerRelativeUrl);return String.format("{0}{1}/{2}",c,this._listUrl,b)},_getItemsByQuery:function(a,b){var c=this._createDeferred();b=b||new SPListRepo.QuerySettings(SPListRepo.ViewScope.FilesFolders);var d=this._getViewQuery(a,b.viewScope,b.viewFields,b.rowLimit);return this._loadListDeffered.done(Function.createDelegate(this,function(){this.folder&&d.set_folderServerRelativeUrl(this._getFolderRelativeUrl());var a=this._list.getItems(d);this._context.load(a);var b=this;this._context.executeQueryAsync(function(){for(var d=a.getEnumerator(),e=[];d.moveNext();)e.push(new b._listItemConstructor(d.get_current()));c.resolve(e)},function(a,b){c.reject(new SPListRepo.RequestError(b))})})),c.promise()},_getItemByQuery:function(a,b){var c=this._createDeferred();return this._getItemsByQuery(a,b).done(function(a){if(a.length>1)throw"Result contains more than one element";c.resolve(1===a.length?a[0]:null)}).fail(function(a){c.reject(a)}),c.promise()},_getViewQuery:function(a,b,c,d){var e,f=(this._createDeferred(),(new CamlBuilder).View(c));d&&(f=f.RowLimit(d));var g=CamlBuilder.Expression().IntegerField(SPListRepo.Fields.FSObjType).EqualTo(1);switch(b){case SPListRepo.ViewScope.FilesOnly:f=f.Scope(CamlBuilder.ViewScope.FilesOnly);break;case SPListRepo.ViewScope.FoldersOnly:case SPListRepo.ViewScope.FilesFolders:break;case SPListRepo.ViewScope.FilesOnlyRecursive:f=f.Scope(CamlBuilder.ViewScope.Recursive);break;case SPListRepo.ViewScope.FoldersOnlyRecursive:case SPListRepo.ViewScope.FilesFoldersRecursive:f=f.Scope(CamlBuilder.ViewScope.RecursiveAll);break;default:f=f.Scope(CamlBuilder.ViewScope.RecursiveAll)}e=b===SPListRepo.ViewScope.FoldersOnly||b===SPListRepo.ViewScope.FoldersOnlyRecursive?a?f.Query().Where().All(a,g).ToString():f.Query().Where().All(g).ToString():a?f.Query().Where().All(a).ToString():f.Query().Where().All().ToString(),console.log(e);var h=new SP.CamlQuery;return h.set_viewXml(e),h}},b}(jQuery),SPListRepo.ListRepository.registerClass("SPListRepo.ListRepository");