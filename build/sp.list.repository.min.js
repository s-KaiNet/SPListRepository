Type.registerNamespace("SPListRepo");var SPListRepo;!function(e){var t=function(){function e(){}return e.ensureTrailingSlash=function(e){return e.endsWith("/")?e:e+"/"},e.ensureLeadingSlash=function(e){return"/"!==e.substr(0,1)?"/"+e:e},e}();e.Helper=t}(SPListRepo||(SPListRepo={})),Type.registerNamespace("SPListRepo.Fields"),Type.registerNamespace("SPListRepo.ErrorCodes");var SPListRepo;!function(e){var t;!function(e){e.Modified="Modified",e.Created="Created",e.ModifiedBy="Editor",e.CreatedBy="Author",e.ID="ID",e.FSObjType="FSObjType",e.Title="Title",e.FileLeafRef="FileLeafRef",e.FileDirRef="FileDirRef",e.ContentTypeId="ContentTypeId"}(t=e.Fields||(e.Fields={}))}(SPListRepo||(SPListRepo={}));var SPListRepo;!function(e){var t;!function(e){e.FolderAlreadyExists=-2130245363,e.IllegalName=-2130575245}(t=e.ErrorCodes||(e.ErrorCodes={}))}(SPListRepo||(SPListRepo={}));var SPListRepo;!function(e){var t=function(){function e(e){e instanceof SP.ClientRequestFailedEventArgs?(this.stackTrace=e.get_stackTrace(),this.message=e.get_message(),this.correlation=e.get_errorTraceCorrelationId(),this.errorCode=e.get_errorCode(),this.details=e.get_errorDetails(),this.errorType=e.get_errorTypeName()):"string"==typeof e&&(this.message=e)}return e}();e.RequestError=t}(SPListRepo||(SPListRepo={}));var SPListRepo;!function(e){var t=function(){function e(e,t,r){this.viewScope=e,this.viewFields=t,this.rowLimit=r}return e}();e.QuerySettings=t}(SPListRepo||(SPListRepo={}));var SPListRepo;!function(e){var t=function(){function t(){this.$=jQuery}return t.getListByUrl=function(r){var i=$.Deferred(),o=e.Helper.ensureTrailingSlash(_spPageContextInfo.webAbsoluteUrl),s=e.Helper.ensureTrailingSlash(_spPageContextInfo.webServerRelativeUrl),n=String.format("{0}_api/web/lists/?$expand=RootFolder&$filter=RootFolder/ServerRelativeUrl eq '{1}{2}'&$select=ID",o,s,r),l=SP.ClientContext.get_current(),u=function(e){i.resolve(e)},a=function(e){i.reject(e)};if(l.get_web().getList){var c=l.get_web().getList(String.format("{0}{1}",s,r));l.load(c),l.executeQueryAsync(function(){u(c)},function(t,r){a(new e.RequestError(r))})}else t.getListUsingRest(n,u,a);return i.promise()},t.getListById=function(t){var r=$.Deferred(),i=SP.ClientContext.get_current(),o=i.get_web().get_lists().getById(t);return i.load(o,"Title","RootFolder","Id"),i.executeQueryAsync(function(){r.resolve(o)},function(t,i){r.reject(new e.RequestError(i))}),r.promise()},t.getListUsingRest=function(t,r,i){$.ajax({url:t,type:"GET",contentType:"application/json;odata=verbose",headers:{Accept:"application/json;odata=verbose"},success:function(t){var o=SP.ClientContext.get_current(),s=o.get_web().get_lists().getById(t.d.results[0].Id);o.load(s),o.executeQueryAsync(function(){r(s)},function(t,r){i(new e.RequestError(r))})},error:function(t,r){i(new e.RequestError(r))}})},t}();e.ListService=t}(SPListRepo||(SPListRepo={}));var SPListRepo;!function(e){!function(e){e[e.FilesOnly=0]="FilesOnly",e[e.FoldersOnly=1]="FoldersOnly",e[e.FilesFolders=2]="FilesFolders",e[e.FilesOnlyRecursive=3]="FilesOnlyRecursive",e[e.FoldersOnlyRecursive=4]="FoldersOnlyRecursive",e[e.FilesFoldersRecursive=5]="FilesFoldersRecursive"}(e.ViewScope||(e.ViewScope={}));e.ViewScope}(SPListRepo||(SPListRepo={})),Type.registerNamespace("SPListRepo.ViewScope");var SPListRepo;!function(e){var t=function(){function t(t){this.fileLeafRef=void 0,t&&(this.spListItem=t,this.file=this.spListItem.get_file(),this.id=t.get_id(),this.created=this.getFieldValue(e.Fields.Created),this.createdBy=this.getFieldValue(e.Fields.CreatedBy),this.modified=this.getFieldValue(e.Fields.Modified),this.modifiedBy=this.getFieldValue(e.Fields.ModifiedBy),this.title=this.getFieldValue(e.Fields.Title),this.fileDirRef=this.getFieldValue(e.Fields.FileDirRef),this.fileSystemObjectType=this.spListItem.get_fileSystemObjectType())}return t.prototype.getFieldValue=function(e){var t=this.spListItem.get_fieldValues()[e];return"undefined"!=typeof t?this.spListItem.get_item(e):void 0},t}();e.BaseListItem=t}(SPListRepo||(SPListRepo={}));var SPListRepo;!function(e){var t=function(){function t(t,r){var i=this;this._listItemConstructor=r,this._context=SP.ClientContext.get_current(),t instanceof SP.Guid?this._loadListDeferred=e.ListService.getListById(t):"string"==typeof t&&(this._loadListDeferred=e.ListService.getListByUrl(t)),this._loadListDeferred.done(function(e){i._list=e}).fail(function(e){alert(e.message)})}return t.prototype.getItems=function(e){return this._getItemsByExpression(null,e)},t.prototype.getItemById=function(t){var r=this;return this._withPromise(function(i){var o=r._list.getItemById(t);r._context.load(o),r._context.executeQueryAsync(function(){var e=new r._listItemConstructor(o);i.resolve(e)},function(t,r){i.reject(new e.RequestError(r))})})},t.prototype.getItemsByIds=function(t,r){var i=CamlBuilder.Expression().CounterField(e.Fields.ID).In(t);return this._getItemsByExpression(i,r)},t.prototype.getItemsInsideFolders=function(t,r){var i=this,o=CamlBuilder.Expression().TextField(e.Fields.FileDirRef).In(t.map(function(e){var t=i._getFolderRelativeUrl(e);return 0===t.indexOf("/")&&(t=t.substring(1)),t}));return this._getItemsByExpression(o,r)},t.prototype.getLastAddedItem=function(t){var r=CamlBuilder.Expression().CounterField(e.Fields.ID).NotEqualTo(0);t=t||new e.QuerySettings(e.ViewScope.FilesFolders),t.rowLimit=1;var i=this._getSPCamlQuery(this._getViewQuery(r,t).OrderByDesc(e.Fields.ID));return this._getItemBySPCamlQuery(i)},t.prototype.getLastModifiedItem=function(t){var r=CamlBuilder.Expression().CounterField(e.Fields.ID).NotEqualTo(0);t=t||new e.QuerySettings(e.ViewScope.FilesFolders),t.rowLimit=1;var i=this._getSPCamlQuery(this._getViewQuery(r,t).OrderByDesc(e.Fields.Modified));return this._getItemBySPCamlQuery(i)},t.prototype.saveItem=function(e){return!e.id||e.id<1?this._addItem(e):this._updateItem(e)},t.prototype.deleteItem=function(t){var r=this;return this._withPromise(function(i){var o=r._list.getItemById(t.id);r._context.load(o),o.deleteObject(),r._context.executeQueryAsync(function(){i.resolve()},function(t,r){i.reject(new e.RequestError(r))})})},t.prototype.createFolder=function(t){var r=this;return this._withPromise(function(i){var o=new SP.ListItemCreationInformation;o.set_underlyingObjectType(SP.FileSystemObjectType.folder),o.set_leafName(t);var s=r._list.addItem(o);s.set_item("Title",t),s.update(),r._context.load(s),r._context.executeQueryAsync(function(){i.resolve(s)},function(t,r){i.reject(new e.RequestError(r))})})},t.prototype.createFile=function(t,r,i){var o=this;return this._withPromise(function(s){var n=new SP.FileCreationInformation;n.set_url(t),n.set_overwrite(i),n.set_content(new SP.Base64EncodedByteArray);for(var l=0;l<r.length;l++)n.get_content().append(r.charCodeAt(l));var u=o._context.get_web().getFolderByServerRelativeUrl(o._getFolderRelativeUrl()).get_files().add(n);o._context.load(u),o._context.executeQueryAsync(function(){s.resolve(u)},function(t,r){s.reject(new e.RequestError(r))})})},t.prototype._getItemBySPCamlQuery=function(e){var t=this._createDeferred();return this._getItemsBySPCamlQuery(e).done(function(e){if(e.length>1)throw"Result contains more than one element";t.resolve(1===e.length?e[0]:null)}).fail(function(e){t.reject(e)}),t.promise()},t.prototype._addItem=function(t){var r=this;return this._withPromise(function(i){var o=new SP.ListItemCreationInformation;r.folder&&o.set_folderUrl(r._getFolderRelativeUrl());var s=r._list.addItem(o);r._setFieldValues(s,t);var n=r;s.update(),r._context.load(s),r._context.executeQueryAsync(function(){var e=new n._listItemConstructor(s);i.resolve(e)},function(t,r){i.reject(new e.RequestError(r))})})},t.prototype._updateItem=function(t){var r=this;return this._withPromise(function(i){var o=r._list.getItemById(t.id);r._context.load(o),r._setFieldValues(o,t);var s=r;o.update(),r._context.executeQueryAsync(function(){var e=new s._listItemConstructor(o);i.resolve(e)},function(t,r){i.reject(new e.RequestError(r))})})},t.prototype._setFieldValues=function(t,r){t.set_item(e.Fields.Title,r.title),r.fileLeafRef&&t.set_item(e.Fields.FileLeafRef,r.fileLeafRef)},t.prototype._getItemsByExpression=function(t,r){r=r||new e.QuerySettings(e.ViewScope.FilesFolders);var i=this._getSPCamlQuery(this._getViewQuery(t,r));return this._getItemsBySPCamlQuery(i)},t.prototype._getViewQuery=function(t,r){var i,o=(new CamlBuilder).View(r.viewFields);r.rowLimit&&(o=o.RowLimit(r.rowLimit));var s=CamlBuilder.Expression().IntegerField(e.Fields.FSObjType).EqualTo(1);switch(r.viewScope){case e.ViewScope.FilesOnly:o=o.Scope(CamlBuilder.ViewScope.FilesOnly);break;case e.ViewScope.FoldersOnly:case e.ViewScope.FilesFolders:break;case e.ViewScope.FilesOnlyRecursive:o=o.Scope(CamlBuilder.ViewScope.Recursive);break;case e.ViewScope.FoldersOnlyRecursive:case e.ViewScope.FilesFoldersRecursive:o=o.Scope(CamlBuilder.ViewScope.RecursiveAll);break;default:o=o.Scope(CamlBuilder.ViewScope.RecursiveAll)}return i=r.viewScope===e.ViewScope.FoldersOnly||r.viewScope===e.ViewScope.FoldersOnlyRecursive?t?o.Query().Where().All(t,s):o.Query().Where().All(s):t?o.Query().Where().All(t):o.Query().Where().All()},t.prototype._getSPCamlQuery=function(e){var t=e.ToString();console.log("Running query:"),console.log(t);var r=new SP.CamlQuery;return r.set_viewXml(t),r},t.prototype._getItemsBySPCamlQuery=function(t){var r=this;return this._withPromise(function(i){r.folder&&t.set_folderServerRelativeUrl(r._getFolderRelativeUrl());var o=r._list.getItems(t);r._context.load(o);var s=r;r._context.executeQueryAsync(function(){for(var e,t=o.getEnumerator();t.moveNext();)e.push(new s._listItemConstructor(t.get_current()));i.resolve(e)},function(t,r){i.reject(new e.RequestError(r))})})},t.prototype._getFolderRelativeUrl=function(t){var r=t||this.folder,i=this._list.get_rootFolder().get_serverRelativeUrl();return i=e.Helper.ensureTrailingSlash(i),String.format("{0}{1}",i,r)},t.prototype._createDeferred=function(){return jQuery.Deferred()},t.prototype._withPromise=function(e){var t=this._createDeferred();return this._loadListDeferred.done(function(){e(t)}),t.promise()},t}();e.ListRepository=t}(SPListRepo||(SPListRepo={}));