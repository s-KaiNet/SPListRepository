Type.registerNamespace("SPListRepo.Fields"),Type.registerNamespace("SPListRepo.ErrorCodes");var SPListRepo;!function(e){var t;!function(e){e.Modified="Modified",e.Created="Created",e.ModifiedBy="Editor",e.CreatedBy="Author",e.ID="ID",e.FSObjType="FSObjType",e.Title="Title",e.FileLeafRef="FileLeafRef",e.FileDirRef="FileDirRef",e.ContentTypeId="ContentTypeId"}(t=e.Fields||(e.Fields={}))}(SPListRepo||(SPListRepo={}));var SPListRepo;!function(e){var t;!function(e){e.FolderAlreadyExists=-2130245363,e.IllegalName=-2130575245}(t=e.ErrorCodes||(e.ErrorCodes={}))}(SPListRepo||(SPListRepo={})),Type.registerNamespace("SPListRepo");var SPListRepo;!function(e){var t=function(){function e(){}return e.ensureTrailingSlash=function(e){return e.endsWith("/")?e:e+"/"},e.ensureLeadingSlash=function(e){return"/"!==e.substr(0,1)?"/"+e:e},e}();e.Helper=t}(SPListRepo||(SPListRepo={}));var SPListRepo;!function(e){var t=function(){function e(e){e instanceof SP.ClientRequestFailedEventArgs?(this.stackTrace=e.get_stackTrace(),this.message=e.get_message(),this.correlation=e.get_errorTraceCorrelationId(),this.errorCode=e.get_errorCode(),this.details=e.get_errorDetails(),this.errorType=e.get_errorTypeName()):"string"==typeof e&&(this.message=e)}return e}();e.RequestError=t}(SPListRepo||(SPListRepo={}));var SPListRepo;!function(e){!function(e){e[e.FilesOnly=0]="FilesOnly",e[e.FoldersOnly=1]="FoldersOnly",e[e.FilesFolders=2]="FilesFolders",e[e.FilesOnlyRecursive=3]="FilesOnlyRecursive",e[e.FoldersOnlyRecursive=4]="FoldersOnlyRecursive",e[e.FilesFoldersRecursive=5]="FilesFoldersRecursive"}(e.ViewScope||(e.ViewScope={}));e.ViewScope}(SPListRepo||(SPListRepo={})),Type.registerNamespace("SPListRepo.ViewScope");var SPListRepo;!function(e){var t=function(){function t(){this.$=jQuery}return t.getListByUrl=function(r,i){var o,n=$.Deferred(),s=function(e){n.resolve(e)},l=function(e){n.reject(e)},u=SP.ClientContext.get_current(),c=null;i?(o=new SP.AppContextSite(u,i),c=o.get_web(),u.load(c,"Url","ServerRelativeUrl")):o=u;var a=u.get_web();return u.load(a,"Url","ServerRelativeUrl"),u.executeQueryAsync(function(){var n=e.Helper.ensureTrailingSlash(a.get_url()),d=i?e.Helper.ensureTrailingSlash(c.get_serverRelativeUrl()):e.Helper.ensureTrailingSlash(a.get_serverRelativeUrl()),p="";if(p=i?String.format("{0}_api/SP.AppContextSite(@target)/web/lists/?@target='{3}'&$expand=RootFolder&$filter=RootFolder/ServerRelativeUrl eq '{1}{2}'&$select=ID",n,d,r,i):String.format("{0}_api/web/lists/?$expand=RootFolder&$filter=RootFolder/ServerRelativeUrl eq '{1}{2}'&$select=ID",n,d,r),o.get_web().getList){var f=o.get_web().getList(String.format("{0}{1}",d,r));u.load(f,"Title","RootFolder","Id"),u.executeQueryAsync(function(){s(f)},function(t,r){l(new e.RequestError(r))})}else t.getListUsingRest(p,s,l,i)},function(t,r){l(new e.RequestError(r))}),n.promise()},t.getListById=function(t,r){var i,o=$.Deferred(),n=SP.ClientContext.get_current();i=r?new SP.AppContextSite(n,r):n;var s=i.get_web().get_lists().getById(t);return n.load(s,"Title","RootFolder","Id"),n.executeQueryAsync(function(){o.resolve(s)},function(t,r){o.reject(new e.RequestError(r))}),o.promise()},t.getListUsingRest=function(t,r,i,o){$.ajax({url:t,type:"GET",contentType:"application/json;odata=verbose",headers:{Accept:"application/json;odata=verbose"},success:function(t){var n,s=SP.ClientContext.get_current();n=o?new SP.AppContextSite(s,o):s;var l=n.get_web().get_lists().getById(t.d.results[0].Id);s.load(l,"Title","RootFolder","Id"),s.executeQueryAsync(function(){r(l)},function(t,r){i(new e.RequestError(r))})},error:function(t,r){i(new e.RequestError(r))}})},t}();e.ListService=t}(SPListRepo||(SPListRepo={}));var SPListRepo;!function(e){var t=function(){function e(e,t,r){this.viewScope=e,this.viewFields=t,this.rowLimit=r}return e}();e.QuerySettings=t}(SPListRepo||(SPListRepo={}));var SPListRepo;!function(e){var t=function(){function e(e){this.dfd=e}return e.prototype.done=function(e){return this.dfd.promise.then(e),this},e.prototype.fail=function(e){return this.dfd.promise["catch"](e),this},e.prototype.then=function(e,t){return this.dfd.promise.then(e,t),this},e.prototype.always=function(e){return this.dfd.promise["finally"](e),this},e.prototype.getUnderlyingPromise=function(){return this.dfd.promise},e}();e.ngPromise=t}(SPListRepo||(SPListRepo={}));var SPListRepo;!function(e){var t=function(){function e(e){this.dfd=e}return e.prototype.done=function(e){return this.dfd.promise().done(e),this},e.prototype.fail=function(e){return this.dfd.promise().fail(e),this},e.prototype.then=function(e,t){return this.dfd.promise().then(e,t),this},e.prototype.always=function(e){return this.dfd.promise().always(e),this},e.prototype.getUnderlyingPromise=function(){return this.dfd.promise()},e}();e.jQPromise=t}(SPListRepo||(SPListRepo={}));var SPListRepo;!function(e){var t=function(){function e(e){this.dfd=e}return e.prototype.done=function(e){return this.dfd.promise.done(e),this},e.prototype.fail=function(e){return this.dfd.promise["catch"](e),this},e.prototype.then=function(e,t){return this.dfd.promise.then(e,t),this},e.prototype.always=function(e){return this.dfd.promise["finally"](e),this},e.prototype.getUnderlyingPromise=function(){return this.dfd.promise},e}();e.QPromise=t}(SPListRepo||(SPListRepo={}));var SPListRepo;!function(e){var t=function(){function t(){var e=angular.injector(["ng"]).get("$q");this.dfd=e.defer()}return t.prototype.promise=function(){return new e.ngPromise(this.dfd)},t.prototype.resolve=function(e){return this.dfd.resolve(e)},t.prototype.reject=function(){return this.dfd.reject()},t}();e.ngDeferred=t}(SPListRepo||(SPListRepo={}));var SPListRepo;!function(e){var t=function(){function t(){this.dfd=jQuery.Deferred()}return t.prototype.promise=function(){return new e.jQPromise(this.dfd)},t.prototype.resolve=function(e){return this.dfd.resolve(e)},t.prototype.reject=function(e){return this.dfd.reject(e)},t}();e.jQDeferred=t}(SPListRepo||(SPListRepo={}));var SPListRepo;!function(e){var t=function(){function t(){this.dfd=Q.defer()}return t.prototype.promise=function(){return new e.QPromise(this.dfd)},t.prototype.resolve=function(e){return this.dfd.resolve(e)},t.prototype.reject=function(e){return this.dfd.reject(e)},t}();e.QDeferred=t}(SPListRepo||(SPListRepo={}));var SPListRepo;!function(e){var t=function(){function t(e){this.fileLeafRef=void 0,e&&this.mapFromListItem(e)}return t.prototype.mapFromListItem=function(t){this.spListItem=t,this.file=this.spListItem.get_file(),this.id=t.get_id(),this.created=this.getFieldValue(e.Fields.Created),this.createdBy=this.getFieldValue(e.Fields.CreatedBy),this.modified=this.getFieldValue(e.Fields.Modified),this.modifiedBy=this.getFieldValue(e.Fields.ModifiedBy),this.title=this.getFieldValue(e.Fields.Title),this.fileDirRef=this.getFieldValue(e.Fields.FileDirRef),this.fileSystemObjectType=this.spListItem.get_fileSystemObjectType()},t.prototype.mapToListItem=function(t){this.setFieldValue(t,e.Fields.Title,this.title),this.setFieldValue(t,e.Fields.FileLeafRef,this.fileLeafRef)},t.prototype.getFieldValue=function(e){var t=this.spListItem.get_fieldValues()[e];return"undefined"!=typeof t?this.spListItem.get_item(e):void 0},t.prototype.setFieldValue=function(e,t,r){void 0!==r&&e.set_item(t,r)},t}();e.BaseListItem=t}(SPListRepo||(SPListRepo={}));var SPListRepo;!function(e){var t=function(){function t(t,r,i){var o=this;this._listItemConstructor=r,this._context=SP.ClientContext.get_current(),t instanceof SP.Guid?this._loadListDeferred=e.ListService.getListById(t,i):"string"==typeof t&&(this._loadListDeferred=e.ListService.getListByUrl(t,i)),this._loadListDeferred.done(function(e){o._list=e}).fail(function(e){alert(e.message)})}return t.prototype.getItems=function(e){return this._getItemsByExpression(null,e)},t.prototype.getItemById=function(t){var r=this;return this._withPromise(function(i){var o=r._list.getItemById(t);r._context.load(o),r._context.executeQueryAsync(function(){var e=new r._listItemConstructor(o);i.resolve(e)},function(t,r){i.reject(new e.RequestError(r))})})},t.prototype.getItemsByTitle=function(t,r){var i=CamlBuilder.Expression().TextField(e.Fields.Title).EqualTo(t);return this._getItemsByExpression(i,r)},t.prototype.getItemsByIds=function(t,r){var i=CamlBuilder.Expression().CounterField(e.Fields.ID).In(t);return this._getItemsByExpression(i,r)},t.prototype.getItemsInsideFolders=function(t,r){var i=this,o=CamlBuilder.Expression().TextField(e.Fields.FileDirRef).In(t.map(function(e){var t=i._getFolderRelativeUrl(e);return 0===t.indexOf("/")&&(t=t.substring(1)),t}));return this._getItemsByExpression(o,r)},t.prototype.getLastAddedItem=function(t,r){void 0===r&&(r=!1);var i,o=CamlBuilder.Expression().CounterField(e.Fields.ID).NotEqualTo(0);i=r?new e.QuerySettings(e.ViewScope.FilesOnlyRecursive,t,1):new e.QuerySettings(e.ViewScope.FilesOnly,t,1);var n=this._getSPCamlQuery(this._getViewQuery(o,i).OrderByDesc(e.Fields.ID));return this._getItemBySPCamlQuery(n)},t.prototype.getLastModifiedItem=function(t,r){void 0===r&&(r=!1);var i,o=CamlBuilder.Expression().CounterField(e.Fields.ID).NotEqualTo(0);i=r?new e.QuerySettings(e.ViewScope.FilesOnlyRecursive,t,1):new e.QuerySettings(e.ViewScope.FilesOnly,t,1);var n=this._getSPCamlQuery(this._getViewQuery(o,i).OrderByDesc(e.Fields.Modified));return this._getItemBySPCamlQuery(n)},t.prototype.saveItem=function(e){return!e.id||e.id<1?this._addItem(e):this._updateItem(e)},t.prototype.deleteItem=function(t){var r=this;return this._withPromise(function(i){var o=r._list.getItemById(t.id);r._context.load(o),o.deleteObject(),r._context.executeQueryAsync(function(){i.resolve()},function(t,r){i.reject(new e.RequestError(r))})})},t.prototype.createFolder=function(t){var r=this;return this._withPromise(function(i){var o=new SP.ListItemCreationInformation;o.set_underlyingObjectType(SP.FileSystemObjectType.folder),o.set_leafName(t);var n=r._list.addItem(o);n.set_item(e.Fields.Title,t),n.update();var s=r;r._context.load(n),r._context.executeQueryAsync(function(){var e=new s._listItemConstructor(n);i.resolve(e)},function(t,r){i.reject(new e.RequestError(r))})})},t.prototype.createFile=function(t,r,i){var o=this;return this._withPromise(function(n){var s=new SP.FileCreationInformation;s.set_url(t),s.set_overwrite(i),s.set_content(new SP.Base64EncodedByteArray);for(var l=0;l<r.length;l++)s.get_content().append(r.charCodeAt(l));var u=o._list.get_parentWeb().getFolderByServerRelativeUrl(o._getFolderRelativeUrl()).get_files().add(s);o._context.load(u),o._context.executeQueryAsync(function(){n.resolve(u)},function(t,r){n.reject(new e.RequestError(r))})})},t.prototype._getItemBySPCamlQuery=function(e){var t=this._createDeferred();return this._getItemsBySPCamlQuery(e).done(function(e){if(e.length>1)throw"Result contains more than one element";t.resolve(1===e.length?e[0]:null)}).fail(function(e){t.reject(e)}),t.promise()},t.prototype._addItem=function(t){var r=this;return this._withPromise(function(i){var o=new SP.ListItemCreationInformation;r.folder&&o.set_folderUrl(r._getFolderRelativeUrl());var n=r._list.addItem(o);t.mapToListItem(n);var s=r;n.update(),r._context.load(n),r._context.executeQueryAsync(function(){var e=new s._listItemConstructor(n);i.resolve(e)},function(t,r){i.reject(new e.RequestError(r))})})},t.prototype._updateItem=function(t){var r=this;return this._withPromise(function(i){var o=r._list.getItemById(t.id);r._context.load(o),t.mapToListItem(o);var n=r;o.update(),r._context.executeQueryAsync(function(){var e=new n._listItemConstructor(o);i.resolve(e)},function(t,r){i.reject(new e.RequestError(r))})})},t.prototype._getItemsByExpression=function(t,r){r=r||new e.QuerySettings(e.ViewScope.FilesFolders);var i=this._getSPCamlQuery(this._getViewQuery(t,r));return this._getItemsBySPCamlQuery(i)},t.prototype._getItemByExpression=function(t,r){r=r||new e.QuerySettings(e.ViewScope.FilesFolders);var i=this._getSPCamlQuery(this._getViewQuery(t,r));return this._getItemBySPCamlQuery(i)},t.prototype._getViewQuery=function(t,r){var i,o=(new CamlBuilder).View(r.viewFields);r.rowLimit&&(o=o.RowLimit(r.rowLimit));var n=CamlBuilder.Expression().IntegerField(e.Fields.FSObjType).EqualTo(1);switch(r.viewScope){case e.ViewScope.FilesOnly:o=o.Scope(CamlBuilder.ViewScope.FilesOnly);break;case e.ViewScope.FoldersOnly:case e.ViewScope.FilesFolders:break;case e.ViewScope.FilesOnlyRecursive:o=o.Scope(CamlBuilder.ViewScope.Recursive);break;case e.ViewScope.FoldersOnlyRecursive:case e.ViewScope.FilesFoldersRecursive:o=o.Scope(CamlBuilder.ViewScope.RecursiveAll);break;default:o=o.Scope(CamlBuilder.ViewScope.RecursiveAll)}return i=r.viewScope===e.ViewScope.FoldersOnly||r.viewScope===e.ViewScope.FoldersOnlyRecursive?t?o.Query().Where().All(t,n):o.Query().Where().All(n):t?o.Query().Where().All(t):o.Query().Where().All()},t.prototype._getSPCamlQuery=function(e){var t=e.ToString(),r=new SP.CamlQuery;return r.set_viewXml(t),r},t.prototype._getItemsBySPCamlQuery=function(t){var r=this;return this._withPromise(function(i){r.folder&&t.set_folderServerRelativeUrl(r._getFolderRelativeUrl());var o=r._list.getItems(t);r._context.load(o);var n=r;r._context.executeQueryAsync(function(){for(var e=o.getEnumerator(),t=[];e.moveNext();)t.push(new n._listItemConstructor(e.get_current()));i.resolve(t)},function(t,r){i.reject(new e.RequestError(r))})})},t.prototype._getFolderRelativeUrl=function(t){var r=t||this.folder,i=this._list.get_rootFolder().get_serverRelativeUrl();return i=e.Helper.ensureTrailingSlash(i),String.format("{0}{1}",i,r)},t.prototype._createDeferred=function(){return new e.jQDeferred},t.prototype._withPromise=function(e){var t=this._createDeferred();return this._loadListDeferred.done(function(){e(t)}),t.promise()},t}();e.ListRepository=t}(SPListRepo||(SPListRepo={}));