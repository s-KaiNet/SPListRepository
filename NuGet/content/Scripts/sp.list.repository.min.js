Type.registerNamespace("SPListRepo");var SPListRepo;!function(e){var t=function(){function e(){}return e.ensureTrailingSlash=function(e){return e.endsWith("/")?e:e+"/"},e.ensureLeadingSlash=function(e){return"/"!==e.substr(0,1)?"/"+e:e},e}();e.Helper=t}(SPListRepo||(SPListRepo={})),Type.registerNamespace("SPListRepo.Fields"),Type.registerNamespace("SPListRepo.ErrorCodes");var SPListRepo;!function(e){var t;!function(e){e.Modified="Modified",e.Created="Created",e.ModifiedBy="Editor",e.CreatedBy="Author",e.ID="ID",e.FSObjType="FSObjType",e.Title="Title",e.FileLeafRef="FileLeafRef",e.FileDirRef="FileDirRef",e.ContentTypeId="ContentTypeId"}(t=e.Fields||(e.Fields={}))}(SPListRepo||(SPListRepo={}));var SPListRepo;!function(e){var t;!function(e){e.FolderAlreadyExists=-2130245363,e.IllegalName=-2130575245}(t=e.ErrorCodes||(e.ErrorCodes={}))}(SPListRepo||(SPListRepo={}));var SPListRepo;!function(e){var t=function(){function e(e){e instanceof SP.ClientRequestFailedEventArgs?(this.stackTrace=e.get_stackTrace(),this.message=e.get_message(),this.correlation=e.get_errorTraceCorrelationId(),this.errorCode=e.get_errorCode(),this.details=e.get_errorDetails(),this.errorType=e.get_errorTypeName()):"string"==typeof e&&(this.message=e)}return e}();e.RequestError=t}(SPListRepo||(SPListRepo={}));var SPListRepo;!function(e){var t=function(){function e(e,t,i){this.viewScope=e,this.viewFields=t,this.rowLimit=i}return e}();e.QuerySettings=t}(SPListRepo||(SPListRepo={}));var SPListRepo;!function(e){var t=function(){function t(){this.$=jQuery}return t.getListByUrl=function(i){var r=$.Deferred(),o=function(e){r.resolve(e)},s=function(e){r.reject(e)},n=SP.ClientContext.get_current(),l=n.get_web();return n.load(l,"Url","ServerRelativeUrl"),n.executeQueryAsync(function(){var r=e.Helper.ensureTrailingSlash(l.get_url()),u=e.Helper.ensureTrailingSlash(l.get_serverRelativeUrl()),a=String.format("{0}_api/web/lists/?$expand=RootFolder&$filter=RootFolder/ServerRelativeUrl eq '{1}{2}'&$select=ID",r,u,i);if(n.get_web().getList){var c=n.get_web().getList(String.format("{0}{1}",u,i));n.load(c,"Title","RootFolder","Id"),n.executeQueryAsync(function(){o(c)},function(t,i){s(new e.RequestError(i))})}else t.getListUsingRest(a,o,s)},function(t,i){s(new e.RequestError(i))}),r.promise()},t.getListById=function(t){var i=$.Deferred(),r=SP.ClientContext.get_current(),o=r.get_web().get_lists().getById(t);return r.load(o,"Title","RootFolder","Id"),r.executeQueryAsync(function(){i.resolve(o)},function(t,r){i.reject(new e.RequestError(r))}),i.promise()},t.getListUsingRest=function(t,i,r){$.ajax({url:t,type:"GET",contentType:"application/json;odata=verbose",headers:{Accept:"application/json;odata=verbose"},success:function(t){var o=SP.ClientContext.get_current(),s=o.get_web().get_lists().getById(t.d.results[0].Id);o.load(s,"Title","RootFolder","Id"),o.executeQueryAsync(function(){i(s)},function(t,i){r(new e.RequestError(i))})},error:function(t,i){r(new e.RequestError(i))}})},t}();e.ListService=t}(SPListRepo||(SPListRepo={}));var SPListRepo;!function(e){!function(e){e[e.FilesOnly=0]="FilesOnly",e[e.FoldersOnly=1]="FoldersOnly",e[e.FilesFolders=2]="FilesFolders",e[e.FilesOnlyRecursive=3]="FilesOnlyRecursive",e[e.FoldersOnlyRecursive=4]="FoldersOnlyRecursive",e[e.FilesFoldersRecursive=5]="FilesFoldersRecursive"}(e.ViewScope||(e.ViewScope={}));e.ViewScope}(SPListRepo||(SPListRepo={})),Type.registerNamespace("SPListRepo.ViewScope");var SPListRepo;!function(e){var t=function(){function t(e){this.fileLeafRef=void 0,e&&this.mapFromListItem(e)}return t.prototype.mapFromListItem=function(t){this.spListItem=t,this.file=this.spListItem.get_file(),this.id=t.get_id(),this.created=this.getFieldValue(e.Fields.Created),this.createdBy=this.getFieldValue(e.Fields.CreatedBy),this.modified=this.getFieldValue(e.Fields.Modified),this.modifiedBy=this.getFieldValue(e.Fields.ModifiedBy),this.title=this.getFieldValue(e.Fields.Title),this.fileDirRef=this.getFieldValue(e.Fields.FileDirRef),this.fileSystemObjectType=this.spListItem.get_fileSystemObjectType()},t.prototype.mapToListItem=function(t){this.setFieldValue(t,e.Fields.Title,this.title),this.setFieldValue(t,e.Fields.FileLeafRef,this.fileLeafRef)},t.prototype.getFieldValue=function(e){var t=this.spListItem.get_fieldValues()[e];return"undefined"!=typeof t?this.spListItem.get_item(e):void 0},t.prototype.setFieldValue=function(e,t,i){void 0!==i&&e.set_item(t,i)},t}();e.BaseListItem=t}(SPListRepo||(SPListRepo={}));var SPListRepo;!function(e){var t=function(){function t(t,i){var r=this;this._listItemConstructor=i,this._context=SP.ClientContext.get_current(),t instanceof SP.Guid?this._loadListDeferred=e.ListService.getListById(t):"string"==typeof t&&(this._loadListDeferred=e.ListService.getListByUrl(t)),this._loadListDeferred.done(function(e){r._list=e}).fail(function(e){alert(e.message)})}return t.prototype.getItems=function(e){return this._getItemsByExpression(null,e)},t.prototype.getItemById=function(t){var i=this;return this._withPromise(function(r){var o=i._list.getItemById(t);i._context.load(o),i._context.executeQueryAsync(function(){var e=new i._listItemConstructor(o);r.resolve(e)},function(t,i){r.reject(new e.RequestError(i))})})},t.prototype.getItemsByTitle=function(t,i){var r=CamlBuilder.Expression().TextField(e.Fields.Title).EqualTo(t);return this._getItemsByExpression(r,i)},t.prototype.getItemsByIds=function(t,i){var r=CamlBuilder.Expression().CounterField(e.Fields.ID).In(t);return this._getItemsByExpression(r,i)},t.prototype.getItemsInsideFolders=function(t,i){var r=this,o=CamlBuilder.Expression().TextField(e.Fields.FileDirRef).In(t.map(function(e){var t=r._getFolderRelativeUrl(e);return 0===t.indexOf("/")&&(t=t.substring(1)),t}));return this._getItemsByExpression(o,i)},t.prototype.getLastAddedItem=function(t,i){void 0===i&&(i=!1);var r,o=CamlBuilder.Expression().CounterField(e.Fields.ID).NotEqualTo(0);r=i?new e.QuerySettings(e.ViewScope.FilesOnlyRecursive,t,1):new e.QuerySettings(e.ViewScope.FilesOnly,t,1);var s=this._getSPCamlQuery(this._getViewQuery(o,r).OrderByDesc(e.Fields.ID));return this._getItemBySPCamlQuery(s)},t.prototype.getLastModifiedItem=function(t,i){void 0===i&&(i=!1);var r,o=CamlBuilder.Expression().CounterField(e.Fields.ID).NotEqualTo(0);r=i?new e.QuerySettings(e.ViewScope.FilesOnlyRecursive,t,1):new e.QuerySettings(e.ViewScope.FilesOnly,t,1);var s=this._getSPCamlQuery(this._getViewQuery(o,r).OrderByDesc(e.Fields.Modified));return this._getItemBySPCamlQuery(s)},t.prototype.saveItem=function(e){return!e.id||e.id<1?this._addItem(e):this._updateItem(e)},t.prototype.deleteItem=function(t){var i=this;return this._withPromise(function(r){var o=i._list.getItemById(t.id);i._context.load(o),o.deleteObject(),i._context.executeQueryAsync(function(){r.resolve()},function(t,i){r.reject(new e.RequestError(i))})})},t.prototype.createFolder=function(t){var i=this;return this._withPromise(function(r){var o=new SP.ListItemCreationInformation;o.set_underlyingObjectType(SP.FileSystemObjectType.folder),o.set_leafName(t);var s=i._list.addItem(o);s.set_item(e.Fields.Title,t),s.update();var n=i;i._context.load(s),i._context.executeQueryAsync(function(){var e=new n._listItemConstructor(s);r.resolve(e)},function(t,i){r.reject(new e.RequestError(i))})})},t.prototype.createFile=function(t,i,r){var o=this;return this._withPromise(function(s){var n=new SP.FileCreationInformation;n.set_url(t),n.set_overwrite(r),n.set_content(new SP.Base64EncodedByteArray);for(var l=0;l<i.length;l++)n.get_content().append(i.charCodeAt(l));var u=o._context.get_web().getFolderByServerRelativeUrl(o._getFolderRelativeUrl()).get_files().add(n);o._context.load(u),o._context.executeQueryAsync(function(){s.resolve(u)},function(t,i){s.reject(new e.RequestError(i))})})},t.prototype._getItemBySPCamlQuery=function(e){var t=this._createDeferred();return this._getItemsBySPCamlQuery(e).done(function(e){if(e.length>1)throw"Result contains more than one element";t.resolve(1===e.length?e[0]:null)}).fail(function(e){t.reject(e)}),t.promise()},t.prototype._addItem=function(t){var i=this;return this._withPromise(function(r){var o=new SP.ListItemCreationInformation;i.folder&&o.set_folderUrl(i._getFolderRelativeUrl());var s=i._list.addItem(o);t.mapToListItem(s);var n=i;s.update(),i._context.load(s),i._context.executeQueryAsync(function(){var e=new n._listItemConstructor(s);r.resolve(e)},function(t,i){r.reject(new e.RequestError(i))})})},t.prototype._updateItem=function(t){var i=this;return this._withPromise(function(r){var o=i._list.getItemById(t.id);i._context.load(o),t.mapToListItem(o);var s=i;o.update(),i._context.executeQueryAsync(function(){var e=new s._listItemConstructor(o);r.resolve(e)},function(t,i){r.reject(new e.RequestError(i))})})},t.prototype._getItemsByExpression=function(t,i){i=i||new e.QuerySettings(e.ViewScope.FilesFolders);var r=this._getSPCamlQuery(this._getViewQuery(t,i));return this._getItemsBySPCamlQuery(r)},t.prototype._getItemByExpression=function(t,i){i=i||new e.QuerySettings(e.ViewScope.FilesFolders);var r=this._getSPCamlQuery(this._getViewQuery(t,i));return this._getItemBySPCamlQuery(r)},t.prototype._getViewQuery=function(t,i){var r,o=(new CamlBuilder).View(i.viewFields);i.rowLimit&&(o=o.RowLimit(i.rowLimit));var s=CamlBuilder.Expression().IntegerField(e.Fields.FSObjType).EqualTo(1);switch(i.viewScope){case e.ViewScope.FilesOnly:o=o.Scope(CamlBuilder.ViewScope.FilesOnly);break;case e.ViewScope.FoldersOnly:case e.ViewScope.FilesFolders:break;case e.ViewScope.FilesOnlyRecursive:o=o.Scope(CamlBuilder.ViewScope.Recursive);break;case e.ViewScope.FoldersOnlyRecursive:case e.ViewScope.FilesFoldersRecursive:o=o.Scope(CamlBuilder.ViewScope.RecursiveAll);break;default:o=o.Scope(CamlBuilder.ViewScope.RecursiveAll)}return r=i.viewScope===e.ViewScope.FoldersOnly||i.viewScope===e.ViewScope.FoldersOnlyRecursive?t?o.Query().Where().All(t,s):o.Query().Where().All(s):t?o.Query().Where().All(t):o.Query().Where().All()},t.prototype._getSPCamlQuery=function(e){var t=e.ToString();console.log("Running query:"),console.log(t);var i=new SP.CamlQuery;return i.set_viewXml(t),i},t.prototype._getItemsBySPCamlQuery=function(t){var i=this;return this._withPromise(function(r){i.folder&&t.set_folderServerRelativeUrl(i._getFolderRelativeUrl());var o=i._list.getItems(t);i._context.load(o);var s=i;i._context.executeQueryAsync(function(){for(var e=o.getEnumerator(),t=[];e.moveNext();)t.push(new s._listItemConstructor(e.get_current()));r.resolve(t)},function(t,i){r.reject(new e.RequestError(i))})})},t.prototype._getFolderRelativeUrl=function(t){var i=t||this.folder,r=this._list.get_rootFolder().get_serverRelativeUrl();return r=e.Helper.ensureTrailingSlash(r),String.format("{0}{1}",r,i)},t.prototype._createDeferred=function(){return jQuery.Deferred()},t.prototype._withPromise=function(e){var t=this._createDeferred();return this._loadListDeferred.done(function(){e(t)}),t.promise()},t}();e.ListRepository=t}(SPListRepo||(SPListRepo={}));